<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Portfolio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        .main-content { transition: filter 0.3s ease-in-out; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease-in-out; backdrop-filter: blur(0px); }
        .modal-overlay.active { opacity: 1; visibility: visible; backdrop-filter: blur(5px); }
        .modal-content { background: #1e1e1e; padding: 20px; border-radius: 12px; width: 90%; max-width: 800px; position: relative; }
        .modal-close { position: absolute; top: 10px; right: 20px; font-size: 2rem; color: #fff; cursor: pointer; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="main-content" class="main-content container mx-auto p-4 md:p-8 max-w-6xl">
        <h1 class="text-3xl font-bold text-center text-white mb-8">Dashboard</h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
                <h2 class="text-2xl font-semibold text-white mb-4">My Portfolio</h2>
                <div id="total-value" class="text-lg text-gray-400 mb-6">Total Value: $0.00</div>
                <div class="w-full max-w-md mx-auto mb-10"><canvas id="portfolioChart"></canvas></div>
                
                <div class="bg-gray-800 shadow-md rounded-lg p-6 mb-12">
                    <h2 class="text-2xl font-semibold text-white text-center mb-4">Record a New Transaction</h2>
                    <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label for="stock_symbol" class="block text-sm font-medium text-gray-300">Stock Symbol</label><input type="text" id="stock_symbol" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                        <div><label for="transaction_type" class="block text-sm font-medium text-gray-300">Type</label><select id="transaction_type" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500"><option>BUY</option><option>SELL</option></select></div>
                        <div><label for="quantity" class="block text-sm font-medium text-gray-300">Quantity</label><input type="number" step="0.0001" id="quantity" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                        <div><label for="price_per_share" class="block text-sm font-medium text-gray-300">Price Per Share</label><input type="number" step="0.01" id="price_per_share" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                        <div class="md:col-span-2"><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-lg transition duration-200">Add Transaction</button></div>
                    </form>
                    <p id="form-message" class="text-center mt-4"></p>
                </div>
                
                <div class="bg-gray-800 shadow-md rounded-lg overflow-hidden"><table class="w-full"><thead class="bg-gray-700"><tr><th class="p-4 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">Stock Symbol</th><th class="p-4 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">Quantity</th><th class="p-4 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">Current Price</th><th class="p-4 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">Market Value</th></tr></thead><tbody id="portfolio-body"></tbody></table></div>
                <div id="error-message" class="text-center text-red-500 mt-4"></div>
            </div>

            <div class="lg:col-span-1">
                <h2 class="text-2xl font-semibold text-white mb-4">Popular Stocks</h2>
                <div class="bg-gray-800 shadow-md rounded-lg p-4">
                    <ul id="popular-stocks-list" class="space-y-2"><li>Loading...</li></ul>
                </div>
            </div>
        </div>
    </div>

    <div id="chart-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="closeChartModal()">&times;</span>
            <h2 id="chart-title" class="text-2xl font-semibold text-white text-center mb-4">Stock Chart</h2>
            <div id="chart-container" style="height: 400px;"></div>
        </div>
    </div>

    <script>
        const userId = localStorage.getItem('user_id');
        if (!userId) { window.location.href = 'login.html'; }

        const mainContent = document.getElementById('main-content');
        let portfolioChart = null; 

        function fetchPortfolio() {
            fetch(`http://127.0.0.1:5000/portfolio/${userId}`).then(res => res.json()).then(portfolio => {
                if (portfolio && portfolio.holdings) {
                    document.getElementById('total-value').textContent = `Total Value: ${portfolio.total_portfolio_value.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}`;
                    const portfolioBody = document.getElementById('portfolio-body');
                    portfolioBody.innerHTML = ''; const chartLabels = []; const chartData = [];
                    portfolio.holdings.forEach(stock => {
                        const row = document.createElement('tr');
                        row.innerHTML = `<td class="p-4 border-b border-gray-700 font-medium">${stock.stock_symbol}</td><td class="p-4 border-b border-gray-700">${stock.quantity}</td><td class="p-4 border-b border-gray-700">${stock.current_price.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td><td class="p-4 border-b border-gray-700">${stock.market_value.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>`;
                        portfolioBody.appendChild(row); chartLabels.push(stock.stock_symbol); chartData.push(stock.market_value);
                    });
                    const ctx = document.getElementById('portfolioChart').getContext('2d');
                    if(portfolioChart) portfolioChart.destroy();
                    portfolioChart = new Chart(ctx, { type: 'doughnut', data: { labels: chartLabels, datasets: [{ data: chartData, backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'], hoverOffset: 4 }] },
                        options: { responsive: true, plugins: { legend: { labels: { color: '#e0e0e0' } }, title: { display: true, text: 'Portfolio Distribution', color: '#ffffff' } } }
                    });
                } else { document.getElementById('error-message').textContent = 'Could not load portfolio data.'; }
            }).catch(error => { document.getElementById('error-message').textContent = 'Could not load portfolio data.'; console.error('Error fetching portfolio:', error); });
        }

        function fetchMarketMovers() {
            fetch('http://127.0.0.1:5000/api/market-movers').then(res => res.json()).then(data => {
                const popularStocksList = document.getElementById('popular-stocks-list');
                popularStocksList.innerHTML = '';
                if (data && data.popular_stocks) {
                    data.popular_stocks.forEach(stockSymbol => {
                        const item = document.createElement('li');
                        item.className = 'flex justify-between items-center text-sm p-2 rounded hover:bg-gray-700 cursor-pointer transition transform hover:-translate-y-1';
                        item.setAttribute('onclick', `showChart('${stockSymbol}')`);
                        item.innerHTML = `<span><strong>${stockSymbol}</strong></span>`;
                        popularStocksList.appendChild(item);
                    });
                } else { popularStocksList.innerHTML = '<li class="text-red-500">Could not load data.</li>'; }
            }).catch(err => console.error('Error fetching market movers:', err));
        }

        fetchPortfolio();
        fetchMarketMovers();

        const modal = document.getElementById('chart-modal');
        const chartContainer = document.getElementById('chart-container');
        const chartTitle = document.getElementById('chart-title');
        let candleStickChart = null;

        function showChart(symbol) {
            chartTitle.textContent = `${symbol} - Daily Chart`;
            mainContent.style.filter = 'blur(5px)';
            modal.classList.add('active');
            if (candleStickChart) candleStickChart.remove();
            candleStickChart = LightweightCharts.createChart(chartContainer, { width: 760, height: 400, layout: { backgroundColor: '#1e1e1e', textColor: '#e0e0e0' }, grid: { vertLines: { color: '#2c2c2c' }, horzLines: { color: '#2c2c2c' } } });
            const candlestickSeries = candleStickChart.addCandlestickSeries({ upColor: '#10B981', downColor: '#EF4444', wickUpColor: '#10B981', wickDownColor: '#EF4444', borderVisible: false });

            fetch(`http://127.0.0.1:5000/api/stock-data/${symbol}`).then(res => res.json()).then(data => {
                if (data && data.chart_data && data.chart_data.length > 0) {
                    // --- THIS IS THE FIX ---
                    // The backend already provides the data in the correct format.
                    // We just need to pass it directly to the chart.
                    candlestickSeries.setData(data.chart_data);
                } else {
                    chartContainer.innerHTML = '<p class="text-red-500 text-center">Could not load chart data. The API may have returned an error.</p>';
                }
            }).catch(err => console.error('Error fetching stock data:', err));
        }
        function closeChartModal() {
            mainContent.style.filter = 'none';
            modal.classList.remove('active');
        }
        
        const transactionForm = document.getElementById('transaction-form');
        const formMessage = document.getElementById('form-message');
        transactionForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const now = new Date();
            const transactionDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
            const transactionData = {
                user_id: parseInt(userId), stock_symbol: document.getElementById('stock_symbol').value.toUpperCase(),
                transaction_type: document.getElementById('transaction_type').value, quantity: parseFloat(document.getElementById('quantity').value),
                price_per_share: parseFloat(document.getElementById('price_per_share').value), transaction_date: transactionDate
            };
            fetch('http://127.0.0.1:5000/transactions', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(transactionData) })
                .then(response => response.json()).then(data => {
                    if (data.message) {
                        formMessage.textContent = 'Transaction successful!'; formMessage.style.color = 'lightgreen';
                        transactionForm.reset();
                        setTimeout(() => window.location.reload(), 1000); 
                    } else { formMessage.textContent = data.error || 'Failed to add transaction.'; formMessage.style.color = 'red'; }
                }).catch(error => { console.error('Error:', error); formMessage.textContent = 'An error occurred.'; formMessage.style.color = 'red'; });
        });
    </script>
</body>
</html>
